A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     1


MACRO ASSEMBLER A51 V8.02b
OBJECT MODULE PLACED IN .\Objects\dig_bell_settime.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE dig_bell_settime.asm SET(SMALL) DEBUG PRINT(.\Listings\dig_bell_settime
                      .lst) OBJECT(.\Objects\dig_bell_settime.obj) EP

LOC  OBJ            LINE     SOURCE

0000                   1     org 00h
0000 020100            2     LJMP BEGIN
                       3     ;===================================================================================
                       4     
  00A0                 5             SCL                     EQU     0A0h    ;IN THIS EXAMPLE I USED PORT 2.0
  00A1                 6             SDA                     EQU     0A1h    ;AND PORT 2.1 FOR THE I2C LINES
                       7                                                         ;YOU CAN CHANGE THEM TO WHATEVER ACCEPT
                             ABLE
  00B3                 8             TIME_KEY        EQU             P3.3    ;SET_TIME KEY
  00B4                 9             BELL_KEY        EQU             P3.4    ;SET_BELL KEY
  00B5                10             EMRG_KEY        EQU     P3.5    ;EMERGENCY KEY
                      11     
                      12     ;===================================================================================
                      13     ;=====THE READ AND WRITE COMMANDS (0D0H AND 0D1H)
                      14     
  00D0                15             CONT_BYTE_W             EQU     11010000B
  00D1                16             CONT_BYTE_R             EQU     11010001B
                      17     
                      18     ;===================================================================================
                      19     
0060                  20             ORG    0060H
                      21     
                      22     ;===================================================================================
                      23     ;=====ADD_LOW IS THE DPL, THIS IS THE ADDRESS INISDE THE DS1307
                      24     ;=====DAVAVA IS THE VARIABLE TO STORE DATA WHEN IT GETS BACK FROM THE DS1307
                      25        
  0061                26             DAVAVA          EQU 61H
  0060                27             ADD_LOWL        EQU 60H
  0062                28             memory_address1 EQU 62H
  0063                29             memory_address2 EQU 63H
  0064                30             eeprom_data     EQU 64H
                      31     ;===================================================================================
                      32     ;=====VARIABLES TO STORE THE TIME IN, COULD BE USED ALSO TO STORE DATA TO WRITE ON DS1307
                      33     
  0050                34             SEC                         EQU 50H
  0051                35             MIN                 EQU 51H
  0052                36             HOURS                   EQU     52H
  0067                37             DAY                     EQU     67H
  0053                38             COUNT                   EQU     53H
  0054                39             COUNT1                  EQU 54H
  0055                40             COUNT2          EQU 55H
  0056                41             COUNT3          EQU 56H
  0059                42             COUNT4          EQU 59H
  0057                43             HOURS1                  EQU 57H
  0058                44             MIN1            EQU 58H
  0064                45             COUNT5          EQU 64H
  006B                46             COUNT7          EQU 6BH
  0062                47             HOURS2                  EQU     62H
  0063                48             MINS2           EQU 63H
  0069                49             DAYS            EQU 69H
  006A                50             COUNT6          EQU 6AH
  0068                51             COUNT8          EQU  68H
  0066                52             COUNT9          EQU  66H
  007C                53             PA1             EQU 7CH
  0000                54             MEM_VAL                 EQU     00H
0100                  55             ORG    0100H
                      56     
A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     2

                      57     ;============================================================================
                      58     
0100                  59     BEGIN:
0100 120121           60             LCALL INTI
0103 C2A0             61             CLR SCL
0105 C2A1             62             CLR     SDA
0107 C2A2             63         CLR P2.2
0109 C2B7             64             CLR P3.7
010B 00               65         NOP
010C D2A0             66         SETB    SCL
010E D2A1             67         SETB        SDA
0110 00               68         NOP
0111 C200             69             CLR     MEM_VAL
0113 120147           70             LCALL FIRST
0116 900172           71             MOV DPTR, #WELCOME
0119 120140           72         LCALL DISP_MSG
011C                  73         LOOP:
011C 1201C1           74             LCALL CHECK_KEY
011F 80FB             75             SJMP LOOP
                      76     
                      77     
0121                  78     INTI:   
                      79             ;******************************************
                      80             ;This module initializes the LD
                      81             ;DEPENDANCIES:CMD
                      82             ;******************************************
0121 743C             83             MOV A,#3CH      ;refer manual for the bit meaning
0123 120153           84             LCALL CMD
0126 743C             85             MOV A,#3CH
0128 120153           86             LCALL CMD
012B 743C             87             MOV A,#3CH
012D 120153           88             LCALL CMD
0130 740C             89             MOV A,#0CH
0132 120153           90             LCALL  CMD
0135 7406             91             MOV A,#06H
0137 120153           92             LCALL  CMD
013A 7401             93             MOV A,#01
013C 120153           94             LCALL CMD
013F 22               95             RET
                      96     
                      97     
0140                  98     DISP_MSG:
                      99             ;*****************************************
                     100             ;This module is used to display the message
                     101             ;pointed by dptr on the dptr on the screen
                     102             ;DEPENDANCIES:DISPCH2, DELAY_1SEC
                     103             ;*****************************************
0140 120199          104         LCALL DISPCH2
0143 1201B4          105         LCALL DELAY_1SEC
0146 22              106             RET
                     107     
                     108     
0147                 109     FIRST:
                     110             ;*****************************************
                     111             ;This module moves the cursor back to first
                     112             ;line first position
                     113             ;******************************************
0147 7480            114         MOV A,#80H
0149 120153          115         LCALL CMD
014C 22              116         RET
                     117     
014D                 118     SECOND:
014D 74C0            119             MOV A,#0C0H
014F 120153          120             LCALL CMD
0152 22              121             RET
                     122     
A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     3

                     123     
                     124     
0153                 125     CMD:    
                     126             ;******************************************
                     127             ;This module gives cmd to LCD
                     128             ;cmd should be input through Acc
                     129             ;DEPENDANCIES: READY
                     130             ;******************************************
0153 120161          131             LCALL READY
0156 F580            132             MOV  80H,A
0158 C2A5            133             CLR 0A5H        ; low on RS
015A C2A6            134             CLR 0A6H
015C D2A7            135             SETB 0A7H        ; high to low on En line
015E C2A7            136             CLR 0A7H
0160 22              137             RET
                     138     
                     139     
0161                 140     READY:  
                     141             ;******************************************
                     142             ;This module checks the LCD status
                     143             ;whether busy or not and returns from the 
                     144             ;module only if the busy flag is 0
                     145             ;******************************************
0161 C2A7            146         CLR 0A7H            ;read busy flag
0163 7580FF          147             MOV     80H,#0FFH
0166 C2A5            148             CLR     0A5H
0168 D2A6            149             SETB    0A6H
016A                 150             WAIT:   
016A C2A7            151                     CLR     0A7H
016C D2A7            152                     SETB    0A7H
016E 2087F9          153                     JB      87H,WAIT
0171 22              154             RET
                     155     
0172 20202020        156     WELCOME:   db '    WELCOME!   ',0fh
0176 57454C43                
017A 4F4D4521                
017E 2020200F                
0182 48483A4D        157     MESSAGE1: DB 'HH:MM DAY[0-7]', 0FH
0186 4D204441                
018A 595B302D                
018E 375D0F                  
0191 5F5F3A5F        158     MESSAGE2: DB '__:__ _', 0FH
0195 5F205F0F                
                     159     
                     160     
0199                 161     DISPCH2:
                     162     
                     163             ;******************************************
                     164             ;This module takes the starting add. of the 
                     165             ;string to be displayed in the DPTR and loops
                     166             ;till it find the string terminator #0FH
                     167             ;DEPENDANCIES:DISP
                     168             ;******************************************
0199 00              169             nop
019A                 170             UP11:   
019A E4              171                     CLR A
019B 93              172                     MOVC A,@A+DPTR  ;use lookup table to get ascii character
019C B40F01          173                     CJNE A,#0FH,SKIP
019F 22              174                     RET             
01A0                 175             SKIP:   
01A0 A3              176                     INC DPTR
01A1 1201A6          177                     LCALL  DISP
01A4 80F4            178                     SJMP UP11
                     179     
                     180     
                     181     
A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     4

01A6                 182     DISP:
                     183             ;********************************************
                     184             ;This module takes char. to be displayed in 
                     185             ; the Acc. 
                     186             ;*********************************************
01A6 120161          187             LCALL   READY                               ;DISPLAY SINGLE CHAR
01A9 F580            188             MOV  80H, A
01AB D2A5            189             SETB    0A5H     ; high RS
01AD C2A6            190             CLR     0A6H    ;; low RW
01AF D2A7            191             SETB    0A7H    ; high to low En 
01B1 C2A7            192             CLR     0A7H
01B3 22              193             RET
                     194     
                     195     
01B4                 196     DELAY_1SEC:
                     197             ;********************************************
                     198             ; This module generates delay of 1sec
                     199             ;********************************************
01B4 7F0A            200             MOV R7,#10      
01B6                 201             HERE4:
01B6 7EFF            202                     MOV R6,#0ffh                      ;delay routine for firing
01B8                 203                     HERE31: 
01B8 7DFF            204                                     MOV     R5,#0ffH
01BA                 205                                     REPEAT1:
01BA DDFE            206                                             DJNZ    R5,REPEAT1
01BC DEFA            207                                         DJNZ    R6,HERE31
01BE DFF6            208                                         DJNZ        R7,HERE4        
01C0 22              209                                             RET
                     210     
01C1                 211     CHECK_KEY:
01C1 30B361          212             JNB TIME_KEY, SET_TIME
                     213             ;JNB BELL_KEY, SET_BELL
                     214             ;JNB EMRG_KEY, EMERGENCY
01C4 22              215             RET
                     216     
01C5                 217     KEYPD:   
01C5 7D00            218             MOV R5,#00           
01C7 7590FE          219             MOV 90H,#0FEH   ;scan 1st row
01CA E590            220             MOV A,90H
01CC 64FE            221             XRL A,#0FEH
01CE 702A            222             JNZ ROW
                     223                     
01D0 ED              224             MOV A,R5
01D1 2403            225             ADD A,#03H
01D3 FD              226             MOV R5,A
                     227                   
01D4 7590FD          228             MOV 90H,#0FDH   ;scan 2nd row
01D7 E590            229             MOV A,90H
01D9 64FD            230             XRL A,#0FDH
01DB 701D            231             JNZ ROW
01DD ED              232             MOV A,R5
01DE 2403            233             ADD A,#03H
01E0 FD              234             MOV R5,A
                     235                  
01E1 7590FB          236             MOV 90H,#0FBH   ;scan 3rd row
01E4 E590            237             MOV A,90H
01E6 64FB            238             XRL A,#0FBH
01E8 7010            239             JNZ ROW
01EA ED              240             MOV A,R5
01EB 2403            241             ADD A,#03H
01ED FD              242             MOV R5,A
                     243     
01EE 7590F7          244             MOV 90H,#0F7H   ;scan 4th row
01F1 E590            245             MOV A,90H
01F3 64F7            246             XRL A,#0F7H
01F5 7003            247             JNZ ROW
A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     5

01F7 0201C5          248             LJMP KEYPD
                     249      
01FA                 250             ROW:  
01FA E590            251                     MOV A,90H
01FC 54F0            252             ANL A,#0F0H
01FE C4              253             SWAP A
01FF                 254             REDO:  
01FF 13              255                     RRC A
0200 5003            256                     JNC KEY
0202 0D              257                     INC R5
0203 80FA            258                     SJMP REDO
0205                 259             KEY:
0205 7590F0          260                     MOV 90H,#0F0H
0208 00              261                     NOP
0209 00              262                     NOP
020A E590            263                     MOV     A,90H
                     264     
020C 64F0            265                     XRL     A,#0F0H
020E 70F5            266                     JNZ     KEY
0210 ED              267                     MOV     A,R5
0211 900219          268                     MOV DPTR,#KEYCODE
0214 93              269                     MOVC    A,@A+DPTR
0215 1201B4          270                     LCALL DELAY_1SEC
                     271                     ;LCALL DELAY_1SEC
                     272     
0218 22              273             RET
                     274        
0219 31323334        275     KEYCODE:DB '1','2','3','4','5','6','7','8','9','*','0','#'
021D 35363738                
0221 392A3023                
                     276     
0225                 277     SET_TIME:
0225 120147          278             LCALL FIRST
0228 900182          279             MOV DPTR, #MESSAGE1
022B 120140          280             LCALL DISP_MSG
022E 12014D          281             LCALL SECOND                    ;MOVING CURSOR TO SECOND LINE
0231 900191          282             MOV DPTR, #MESSAGE2
0234 120140          283             LCALL DISP_MSG
0237 12014D          284             LCALL SECOND
023A 740F            285             MOV A, #0FH
023C 120153          286             LCALL CMD
023F 1201C5          287             LCALL KEYPD
0242 1201A6          288             LCALL DISP
0245 1201C5          289             LCALL KEYPD
0248 1201A6          290             LCALL DISP
024B 7414            291             MOV A, #14H
024D 120153          292             LCALL CMD
0250 1201C5          293             LCALL KEYPD
0253 1201A6          294             LCALL DISP
0256 1201C5          295             LCALL KEYPD
0259 1201A6          296             LCALL DISP
025C 7414            297             MOV A, #14H
025E 120153          298             LCALL CMD
0261 1201C5          299             LCALL KEYPD
0264 1201A6          300             LCALL DISP
0267 740C            301             MOV A, #0CH
0269 120153          302             LCALL CMD
026C 22              303             RET
                     304     
                     305     
                     306     
                     307     
                     308     END
A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ADD_LOWL . . . . .  N NUMB   0060H   A   
BEGIN. . . . . . .  C ADDR   0100H   A   
BELL_KEY . . . . .  B ADDR   00B0H.4 A   
CHECK_KEY. . . . .  C ADDR   01C1H   A   
CMD. . . . . . . .  C ADDR   0153H   A   
CONT_BYTE_R. . . .  N NUMB   00D1H   A   
CONT_BYTE_W. . . .  N NUMB   00D0H   A   
COUNT. . . . . . .  N NUMB   0053H   A   
COUNT1 . . . . . .  N NUMB   0054H   A   
COUNT2 . . . . . .  N NUMB   0055H   A   
COUNT3 . . . . . .  N NUMB   0056H   A   
COUNT4 . . . . . .  N NUMB   0059H   A   
COUNT5 . . . . . .  N NUMB   0064H   A   
COUNT6 . . . . . .  N NUMB   006AH   A   
COUNT7 . . . . . .  N NUMB   006BH   A   
COUNT8 . . . . . .  N NUMB   0068H   A   
COUNT9 . . . . . .  N NUMB   0066H   A   
DAVAVA . . . . . .  N NUMB   0061H   A   
DAY. . . . . . . .  N NUMB   0067H   A   
DAYS . . . . . . .  N NUMB   0069H   A   
DELAY_1SEC . . . .  C ADDR   01B4H   A   
DISP . . . . . . .  C ADDR   01A6H   A   
DISPCH2. . . . . .  C ADDR   0199H   A   
DISP_MSG . . . . .  C ADDR   0140H   A   
EEPROM_DATA. . . .  N NUMB   0064H   A   
EMRG_KEY . . . . .  B ADDR   00B0H.5 A   
FIRST. . . . . . .  C ADDR   0147H   A   
HERE31 . . . . . .  C ADDR   01B8H   A   
HERE4. . . . . . .  C ADDR   01B6H   A   
HOURS. . . . . . .  N NUMB   0052H   A   
HOURS1 . . . . . .  N NUMB   0057H   A   
HOURS2 . . . . . .  N NUMB   0062H   A   
INTI . . . . . . .  C ADDR   0121H   A   
KEY. . . . . . . .  C ADDR   0205H   A   
KEYCODE. . . . . .  C ADDR   0219H   A   
KEYPD. . . . . . .  C ADDR   01C5H   A   
LOOP . . . . . . .  C ADDR   011CH   A   
MEMORY_ADDRESS1. .  N NUMB   0062H   A   
MEMORY_ADDRESS2. .  N NUMB   0063H   A   
MEM_VAL. . . . . .  N NUMB   0000H   A   
MESSAGE1 . . . . .  C ADDR   0182H   A   
MESSAGE2 . . . . .  C ADDR   0191H   A   
MIN. . . . . . . .  N NUMB   0051H   A   
MIN1 . . . . . . .  N NUMB   0058H   A   
MINS2. . . . . . .  N NUMB   0063H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
P3 . . . . . . . .  D ADDR   00B0H   A   
PA1. . . . . . . .  N NUMB   007CH   A   
READY. . . . . . .  C ADDR   0161H   A   
REDO . . . . . . .  C ADDR   01FFH   A   
REPEAT1. . . . . .  C ADDR   01BAH   A   
ROW. . . . . . . .  C ADDR   01FAH   A   
SCL. . . . . . . .  N NUMB   00A0H   A   
SDA. . . . . . . .  N NUMB   00A1H   A   
SEC. . . . . . . .  N NUMB   0050H   A   
SECOND . . . . . .  C ADDR   014DH   A   
SET_TIME . . . . .  C ADDR   0225H   A   
SKIP . . . . . . .  C ADDR   01A0H   A   
TIME_KEY . . . . .  B ADDR   00B0H.3 A   
UP11 . . . . . . .  C ADDR   019AH   A   
A51 MACRO ASSEMBLER  DIG_BELL_SETTIME                                                     06/22/2017 15:14:23 PAGE     7

WAIT . . . . . . .  C ADDR   016AH   A   
WELCOME. . . . . .  C ADDR   0172H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
